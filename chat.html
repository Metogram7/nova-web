<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nova Chat — Gelişmiş</title>
<style>
  body {margin:0;font-family:"Segoe UI",sans-serif;display:flex;flex-direction:column;height:100vh;background:#0d0d0d;color:white;transition:background 0.3s,color 0.3s;}
  header {text-align:center;padding:15px;font-size:1.5rem;font-weight:bold;color:#00d4ff;border-bottom:2px solid #00d4ff;background:#080808;position:relative;display:flex;align-items:center;justify-content:center;transition:background 0.3s,color 0.3s;}
  #novaStatus {font-size:0.8rem;margin-left:10px;color:#ffdd00;}
  #menuBtn {position:absolute;right:15px;background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;}
  #menu {position:absolute;right:15px;top:60px;background:#111;border:1px solid #00d4ff;border-radius:12px;padding:10px;display:none;flex-direction:column;min-width:180px;z-index:100;}
  #menu button {margin:5px 0;padding:8px;border:none;border-radius:8px;background:#00d4ff;color:#000;cursor:pointer;transition:0.2s;}
  #menu button:hover {opacity:0.8;}
  #chat {flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;}
  .msg {max-width:80%;margin:8px 0;padding:10px 16px;border-radius:16px;white-space:pre-wrap;word-wrap:break-word;font-size:1rem;line-height:1.4;animation:fadeIn 0.3s ease;position:relative;}
  .msg .timestamp {font-size:0.7rem;color:#999;position:absolute;bottom:-16px;right:10px;}
  .user {background:#b6f0ff;color:#000;align-self:flex-end;margin-left:auto;}
  .nova {background:#111;border:1px solid #00d4ff;color:#00d4ff;align-self:flex-start;margin-right:auto;}
  #inputArea {display:flex;padding:10px 15px;background:#111;border-top:1px solid #00d4ff;gap:5px;}
  #input {flex:1;padding:12px 16px;border-radius:12px;border:none;outline:none;font-size:1rem;background:#111;color:white;}
  button.sendBtn {padding:12px 20px;border-radius:12px;border:none;background:#00d4ff;font-weight:bold;cursor:pointer;transition:0.2s;}
  button.sendBtn:hover {opacity:0.8;}
  button#stopBtn {background:#ff5555;}
  #quickBtns {display:flex;gap:5px;margin-top:5px;flex-wrap:wrap;}
  #quickBtns button {padding:5px 10px;border-radius:8px;border:none;background:#ffdd00;color:#000;cursor:pointer;transition:0.2s;}
  #quickBtns button:hover {opacity:0.8;}
  #emojiPicker {display:flex;gap:5px;flex-wrap:wrap;margin-top:5px;}
  #emojiPicker span {cursor:pointer;font-size:1.2rem;}
  @keyframes fadeIn {from{opacity:0; transform:translateY(10px);}to{opacity:1; transform:translateY(0);} }
  @media(max-width:600px){header {font-size:1.2rem; padding:10px;} #menu {right:5px; top:50px; min-width:150px;} #chat {padding:10px;} #inputArea {flex-direction:column; gap:5px;} #input {width:100%;} button.sendBtn {width:100%;}}
</style>
</head>
<body>

<header>
  💬 Nova Chat <span id="novaStatus">Hazır</span>
  <button id="menuBtn">⋮</button>
  <div id="menu"></div>
</header>

<div id="chat"></div>

<div id="inputArea">
  <input id="input" type="text" placeholder="Bir şey yaz..." autocomplete="off">
  <button class="sendBtn" id="sendBtn">Gönder</button>
  <button class="sendBtn" id="stopBtn">Durdur</button>
</div>

<div id="quickBtns">
  <button>Merhaba</button>
  <button>Nasılsın?</button>
  <button>Hava durumu</button>
</div>

<div id="emojiPicker">
  <span>😀</span><span>😂</span><span>😍</span><span>😎</span><span>🤔</span><span>😢</span>
</div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const stopBtn = document.getElementById("stopBtn");
const menuBtn = document.getElementById("menuBtn");
const menu = document.getElementById("menu");
const novaStatus = document.getElementById("novaStatus");
const quickBtns = document.getElementById("quickBtns");
const emojiPicker = document.getElementById("emojiPicker");
const BACKEND_URL = 'https://nova-backenddd.onrender.com/gemma';
const STORAGE_KEY = "nova_chat_memory";
const INFO_KEY = "nova_user_info";

let userId = localStorage.getItem("nova_user_id");
if(!userId){userId="user_"+Date.now()+"_"+Math.floor(Math.random()*10000); localStorage.setItem("nova_user_id",userId);}
let currentChat = null;
let stopTyping = false;
let typewriterSpeed = 7;
let personality = "normal";
let userInfo = JSON.parse(localStorage.getItem(INFO_KEY)||"{}");

// Menü aç/kapa
menuBtn.onclick = ()=>{ menu.style.display=menu.style.display==="flex"?"none":"flex"; renderMenu(); }

// Menü içeriği
function renderMenu(){
  const allHistory = JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  const userHistory = allHistory[userId]||{};
  menu.innerHTML="";

  const searchInput = document.createElement("input");
  searchInput.placeholder="Geçmişte ara...";
  searchInput.style.marginBottom="10px";
  searchInput.style.padding="5px";
  searchInput.style.borderRadius="8px";
  searchInput.style.border="none";
  searchInput.addEventListener("input",()=>{
    const filter = searchInput.value.toLowerCase();
    Array.from(menu.querySelectorAll(".chatBtn")).forEach(btn=>{
      if(btn.dataset.chatId.toLowerCase().includes(filter)) btn.parentElement.style.display="flex";
      else btn.parentElement.style.display="none";
    });
  });
  menu.appendChild(searchInput);

  const newChatBtn=document.createElement("button");
  newChatBtn.textContent="Yeni Sohbet";
  newChatBtn.onclick=()=>{ startNewChat(); menu.style.display="none"; };
  menu.appendChild(newChatBtn);

  // Kullanıcı bilgileri butonu
  const infoBtn=document.createElement("button");
  infoBtn.textContent="Kullanıcı Bilgileri";
  infoBtn.onclick=()=>{ showUserInfo(); };
  menu.appendChild(infoBtn);

  Object.keys(userHistory).forEach(chatId=>{
    const container=document.createElement("div");
    container.style.display="flex"; container.style.alignItems="center"; container.style.justifyContent="space-between";

    const btn=document.createElement("button");
    btn.textContent=chatId;
    btn.className="chatBtn";
    btn.dataset.chatId=chatId;
    btn.onclick=()=>{ loadChat(chatId); menu.style.display="none"; };
    container.appendChild(btn);

    const delBtn=document.createElement("button");
    delBtn.textContent="🗑️";
    delBtn.style.background="#ff5555"; delBtn.style.color="#fff";
    delBtn.onclick=()=>{ deleteChat(chatId); };
    container.appendChild(delBtn);

    menu.appendChild(container);
  });

  const voiceBtn=document.createElement("button");
  voiceBtn.textContent="Sesli Moda Geç";
  voiceBtn.onclick=()=>{ menu.style.display="none"; window.location.href="voice.html"; };
  menu.appendChild(voiceBtn);

  const personalityBtn=document.createElement("button");
  personalityBtn.textContent="Nova Kişiliği";
  personalityBtn.onclick=()=>{ selectPersonality(); menu.style.display="none"; };
  menu.appendChild(personalityBtn);
}

// Kullanıcı bilgileri göster
function showUserInfo(){
  if(Object.keys(userInfo).length===0) alert("Henüz bilgi yok.");
  else alert("Kullanıcı bilgileri:\n"+JSON.stringify(userInfo,null,2));
}

// Yeni sohbet
function startNewChat(){
  const allHistory=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  if(!allHistory[userId]) allHistory[userId]={};
  const newChatId="Sohbet "+(Object.keys(allHistory[userId]).length+1);
  allHistory[userId][newChatId]=[];
  localStorage.setItem(STORAGE_KEY,JSON.stringify(allHistory));
  currentChat=newChatId;
  chat.innerHTML="";
  renderMenu();
}

// Yükleme
function loadChat(chatId){
  const allHistory=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  const history=(allHistory[userId]||{})[chatId]||[];
  chat.innerHTML="";
  history.forEach(item=>addMessage(item.text,item.sender,false,item.time));
  currentChat=chatId;
}

// Silme
function deleteChat(chatId){
  const allHistory=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
  if(allHistory[userId] && allHistory[userId][chatId]) delete allHistory[userId][chatId];
  localStorage.setItem(STORAGE_KEY,JSON.stringify(allHistory));
  if(currentChat===chatId) chat.innerHTML=""; currentChat=null;
  renderMenu();
}

// Mesaj ekleme
function addMessage(text,sender,save=true,time=null){
  const div=document.createElement("div");
  div.className="msg "+sender;
  div.textContent=text;

  const timestamp=document.createElement("div");
  timestamp.className="timestamp";
  timestamp.textContent=time||new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  div.appendChild(timestamp);

  chat.appendChild(div);
  chat.scroll({top: chat.scrollHeight,behavior:"smooth"});

  if(save && currentChat){
    const allHistory=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
    if(!allHistory[userId]) allHistory[userId]={};
    if(!allHistory[userId][currentChat]) allHistory[userId][currentChat]=[];
    allHistory[userId][currentChat].push({text,sender,time:timestamp.textContent});
    localStorage.setItem(STORAGE_KEY,JSON.stringify(allHistory));

    if(sender==="user") updateUserInfo(text);
  }
  return div;
}

// Kullanıcı bilgisi çıkarma
function updateUserInfo(text){
  text=text.toLowerCase();
  if(text.includes("adım") || text.includes("benim adım")) userInfo.name=text.split("adım")[1]?.trim()?.split(" ")[0];
  if(text.includes("şehir") || text.includes("yaşıyorum")) userInfo.city=text.split("şehir")[1]?.trim()?.split(" ")[0];
  if(text.includes("renk") || text.includes("favori rengim")) userInfo.color=text.split("renk")[1]?.trim()?.split(" ")[0];
  localStorage.setItem(INFO_KEY,JSON.stringify(userInfo));
}

// Emoji
emojiPicker.querySelectorAll("span").forEach(emo=>{ emo.onclick=()=>{ input.value+=emo.textContent; input.focus(); }; });

// Hızlı mesaj
quickBtns.querySelectorAll("button").forEach(btn=>{ btn.onclick=()=>sendMessage(btn.textContent); });

// Gönderme
async function sendMessage(msg=null){
  if(!currentChat) startNewChat();
  const text=msg||input.value.trim();
  if(!text) return;
  addMessage(text,"user");
  input.value="";

  const typingDiv=addMessage("Nova yazıyor...","nova",false);
  novaStatus.textContent="Nova yazıyor...";

  try{
    const res=await fetch(BACKEND_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message:text, personality:personality, userInfo:userInfo})
    });
    const data=await res.json();
    let reply=data.response||"⚠️ Bir hata oluştu 😔";

    typingDiv.textContent="";
    addMessage(reply,"nova");

  }catch(err){typingDiv.textContent="Bağlantı hatası 🚫";}
  novaStatus.textContent="Hazır";
  resetAfkTimer();
}

// Kişilik
function selectPersonality(){
  const p=prompt("Nova kişiliğini seç: normal, eğlenceli, ciddi, öğretici", personality);
  if(p) personality=p;
}

// Enter & buton
sendBtn.onclick=()=>sendMessage();
input.addEventListener("keypress",e=>{if(e.key==="Enter") sendMessage();});

// AFK
let afkTimer=null;
const AFK_TIME=90*1000;
function startAfkTimer(){
  clearTimeout(afkTimer);
  afkTimer=setTimeout(async ()=>{
    novaStatus.textContent="Nova ısınıyor...";
    await new Promise(r=>setTimeout(r,5000));
    novaStatus.textContent="Hazır";
  },AFK_TIME);
}
function resetAfkTimer(){startAfkTimer();}
input.addEventListener("input",resetAfkTimer);
sendBtn.addEventListener("click",resetAfkTimer);

// Sayfa açılışı
const allHistory=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}");
const userHistory=allHistory[userId]||{};
if(Object.keys(userHistory).length>0){
  const lastChat=Object.keys(userHistory)[Object.keys(userHistory).length-1];
  loadChat(lastChat);
}else startNewChat();
startAfkTimer();
</script>
</body>
</html>
